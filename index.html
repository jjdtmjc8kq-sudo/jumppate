<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jump‚Äôn‚ÄôRun ‚Äì Quest Reveal</title>
  <style>
    html, body { margin:0; height:100%; background:#0b0f1a; overflow:hidden; }
    canvas { display:block; margin:0 auto; background:#0b0f1a; touch-action:none; }

    .hud{
      position:fixed; left:12px; top:10px; z-index:10;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      color:#e7ecff; background: rgba(18,26,47,.75);
      border:1px solid rgba(36,48,85,.9);
      border-radius:14px; padding:10px 12px; user-select:none;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .hint{ opacity:.8; font-size:12px; margin-top:6px; max-width: 260px; }

    .controls{
      position:fixed; left:0; right:0; bottom:0; z-index:10;
      display:flex; justify-content:space-between; align-items:flex-end;
      padding:14px; gap:12px; pointer-events:none;
    }
    .pad{ display:flex; gap:12px; pointer-events:auto; }
    .btn{
      width:72px; height:72px; border-radius:18px;
      border:1px solid rgba(46,58,102,1);
      background: rgba(26,37,80,.75);
      color:#e7ecff; font-weight:900; font-size:26px;
      display:grid; place-items:center;
      box-shadow: 0 12px 32px rgba(0,0,0,.35);
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); filter: brightness(1.1); }

    .overlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.55); z-index:20;
      font-family: system-ui, Arial, sans-serif; color:#e7ecff;
    }
    .card{
      width:min(720px, calc(100% - 28px));
      background:#121a2f; border:1px solid #243055;
      border-radius:18px; padding:18px;
      box-shadow: 0 12px 40px rgba(0,0,0,.45);
    }
    .title{ font-size:20px; font-weight:900; margin:0 0 8px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; }
    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      border:1px solid #2e3a66; background:#1a2550; color:#e7ecff;
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:800;
    }
    button:hover{ filter:brightness(1.1); }
  </style>
</head>
<body>
  <canvas id="c"></canvas>

  <div class="hud">
    <div>‚ù§Ô∏è Herzen: <b id="score">0</b> / <b id="target">7</b></div>
    <div class="hint">
      Handy: ‚óÄ ‚ñ∂ + ‚§¥Ô∏é<br>
      PC: Pfeile/WASD + Space
    </div>
  </div>

  <div class="controls">
    <div class="pad">
      <div class="btn" id="left">‚óÄ</div>
      <div class="btn" id="right">‚ñ∂</div>
    </div>
    <div class="pad">
      <div class="btn" id="jump">‚§¥Ô∏é</div>
    </div>
  </div>

  <div id="overlay" class="overlay">
    <div class="card">
      <p class="title">üèÜ Achievement unlocked</p>
      <div id="revealText" class="mono"></div>
      <div class="btnrow">
        <button id="restart">Nochmal spielen</button>
        <button id="close">Schlie√üen</button>
      </div>
    </div>
  </div>

<script>
  // ========= GRUNDDATEN =========
  const PERSON_NAME = "Miriam";  // z.B. "Miriam"
  const ROLE        = "Patentante";      // oder "Patentante"
  const TARGET      = 8;                 // Herzen bis Reveal
  const BABY_LINE   = "Du wurdest f√ºr eine legend√§re Nebenquest ausgew√§hlt.";
  // ==============================

  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const scoreEl = document.getElementById("score");
  const targetEl = document.getElementById("target");
  targetEl.textContent = String(TARGET);

  const overlay = document.getElementById("overlay");
  const revealText = document.getElementById("let ended = false;
function reveal(){
  if (ended) return;
  ended = true;

  playing = false; // <- Das ist der "Freeze" (gewolltes Spielende)

  showEndScreen(
`NEUE QUEST: Patenschaft
======================
NPC: ${PERSON_NAME}
Rolle: ${ROLE}

${BABY_LINE}

Belohnung:
+‚àû Liebe
+999 Herzpunkte
+1 Bonus-Familie

Willst du mein(e) ${ROLE} sein? üíõ`);
}
");
  const restartBtn = document.getElementById("restart");
  const closeBtn = document.getElementById("close");

  // Canvas + Game-Loop via requestAnimationFrame :contentReference[oaicite:7]{index=7}
  let W = 900, H = 520, dpr = 1;
  function resize() {
    dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const maxW = Math.min(980, window.innerWidth);
    const maxH = Math.min(680, window.innerHeight);
    W = Math.floor(maxW);
    H = Math.floor(Math.max(460, Math.min(620, maxH)));
    canvas.style.width = W + "px";
    canvas.style.height = H + "px";
    canvas.width = Math.floor(W * dpr);
    canvas.height = Math.floor(H * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener("resize", resize);
  resize();

  const world = { width: 4200, groundY: 420, gravity: 1900 };

  function rect(x,y,w,h){ return {x,y,w,h}; }
  function heart(x,y){ return {x,y,r:14,taken:false,t:0}; }
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function aabb(a,b){
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
  }

  const platforms = [
    rect(0, world.groundY, world.width, 120),
    rect(420, 330, 160, 18),
    rect(720, 280, 180, 18),
    rect(1050, 320, 140, 18),
    rect(1350, 260, 220, 18),
    rect(1680, 340, 160, 18),
    rect(2020, 300, 180, 18),
    rect(2350, 260, 220, 18),
    rect(2700, 320, 170, 18),
    rect(3040, 280, 220, 18),
    rect(3400, 330, 160, 18),
    rect(3700, 290, 220, 18)
  ];

  const hazards = [
    rect(620,  world.groundY-18, 80, 18),
    rect(1250, world.groundY-18, 90, 18),
    rect(1900, world.groundY-18, 110, 18),
    rect(3180, world.groundY-18, 140, 18)
  ];

  let hearts = [
    heart(460, 300), heart(760, 250), heart(1110, 290),
    heart(1440, 230), heart(1720, 310), heart(2060, 270),
    heart(2440, 230), heart(2760, 290), heart(3100, 250),
    heart(3460, 300), heart(3780, 260)
  ];

  const goal = rect(world.width - 120, world.groundY - 90, 50, 90);

  const player = {
    x: 80, y: world.groundY - 60, w: 34, h: 44,
    vx: 0, vy: 0, speed: 320, jump: 720, onGround: false
  };

  let score = 0;
  let playing = true;

  const input = { left:false, right:false, jump:false };
  const keys = new Set();

  window.addEventListener("keydown", (e) => keys.add(e.key));
  window.addEventListener("keyup", (e) => keys.delete(e.key));

  function updateKeyboard(){
    input.left  ||= keys.has("ArrowLeft") || keys.has("a") || keys.has("A");
    input.right ||= keys.has("ArrowRight") || keys.has("d") || keys.has("D");
    input.jump  ||= keys.has("ArrowUp") || keys.has("w") || keys.has("W") || keys.has(" ");
  }

  // Touch-Buttons via Pointer Events :contentReference[oaicite:8]{index=8}
  bindButton(document.getElementById("left"),  v => input.left = v);
  bindButton(document.getElementById("right"), v => input.right = v);
  bindButton(document.getElementById("jump"),  v => input.jump = v);

  function bindButton(el, setVal){
    let pid = null;
    el.addEventListener("pointerdown", (e) => {
      pid = e.pointerId;
      el.setPointerCapture(pid);
      setVal(true);
      e.preventDefault();
    });
    el.addEventListener("pointerup", (e) => {
      if (e.pointerId !== pid) return;
      setVal(false);
      pid = null;
      e.preventDefault();
    });
    el.addEventListener("pointercancel", () => { setVal(false); pid = null; });
  }

  function resetPlayer(){
    player.x = 80;
    player.y = world.groundY - 60;
    player.vx = 0;
    player.vy = 0;
  }

  function reveal(){
    playing = false;
    revealText.textContent =
`NEUE QUEST: Patenschaft
======================
NPC: ${Miriam}
Rolle: ${Patentante}

${BABY_LINE}

Belohnung:
+‚àû Liebe
+999 Herzpunkte
+1 Bonus-Familie

Willst du mein(e) ${ROLE} sein? üíõ`;
    overlay.style.display = "flex";
  }

  function resetGame(){
    score = 0; scoreEl.textContent = "0";
    hearts = hearts.map(h => ({...h, taken:false, t:0}));
    resetPlayer();
    overlay.style.display = "none";
    playing = true;
  }

  restartBtn.addEventListener("click", resetGame);
  closeBtn.addEventListener("click", () => overlay.style.display = "none");

  let camX = 0;
  let last = performance.now();

  function loop(now){
    const dt = Math.min(0.033, (now - last)/1000);
    last = now;

    updateKeyboard();
    if (playing) step(dt);
    draw();

    // Reset der Tastatur-‚ÄúOR‚Äù-Flags
    if (!keys.size) { /* nichts */ }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  function step(dt){
    let move = 0;
    if (input.left) move -= 1;
    if (input.right) move += 1;
    player.vx = move * player.speed;

    if (input.jump && player.onGround) {
      player.vy = -player.jump;
      player.onGround = false;
    }

    player.vy += world.gravity * dt;

    player.x += player.vx * dt;
    player.x = clamp(player.x, 0, world.width - player.w);
    collide("x");

    player.y += player.vy * dt;
    player.onGround = false;
    collide("y");

    camX = clamp(player.x - W*0.35, 0, world.width - W);

    const pbox = rect(player.x, player.y, player.w, player.h);

    for (const h of hearts) {
      if (h.taken) continue;
      const hb = rect(h.x - 12, h.y - 12, 24, 24);
      if (aabb(pbox, hb)) {
        h.taken = true;
        score++;
        scoreEl.textContent = String(score);
        if (score >= TARGET) reveal();
      }
    }

    for (const hz of hazards) {
      if (aabb(pbox, hz)) {
        score = Math.max(0, score - 1);
        scoreEl.textContent = String(score);
        resetPlayer();
        break;
      }
    }

    if (aabb(pbox, goal)) reveal();

    // Input zur√ºcksetzen (Touch-Buttons setzen es wieder, Tastatur wird pro Frame ge-OR-t)
    if (!keys.size) { input.left=false; input.right=false; input.jump=false; }
  }

  function collide(axis){
    const p = rect(player.x, player.y, player.w, player.h);
    for (const pl of platforms) {
      if (!aabb(p, pl)) continue;
      if (axis === "x") {
        if (player.vx > 0) player.x = pl.x - player.w;
        else if (player.vx < 0) player.x = pl.x + pl.w;
        p.x = player.x;
      } else {
        if (player.vy > 0) {
          player.y = pl.y - player.h;
          player.vy = 0;
          player.onGround = true;
        } else if (player.vy < 0) {
          player.y = pl.y + pl.h;
          player.vy = 0;
        }
        p.y = player.y;
      }
    }
  }

  function draw(){
    ctx.clearRect(0,0,W,H);

    ctx.globalAlpha = 0.25;
    for (let i=0;i<70;i++) ctx.fillRect((i*131 % W), (i*241 % H), 2, 2);
    ctx.globalAlpha = 1;

    ctx.strokeStyle = "rgba(36,48,85,.9)";
    ctx.lineWidth = 2;
    ctx.strokeRect(8, 8, W-16, H-16);

    ctx.save();
    ctx.translate(-camX, 0);

    for (const pl of platforms) {
      ctx.fillStyle = "rgba(18,26,47,1)";
      ctx.fillRect(pl.x, pl.y, pl.w, pl.h);
      ctx.strokeStyle = "rgba(36,48,85,.9)";
      ctx.strokeRect(pl.x, pl.y, pl.w, pl.h);
    }

    for (const hz of hazards) {
      ctx.strokeStyle = "rgba(231,236,255,.7)";
      ctx.lineWidth = 2;
      const n = Math.floor(hz.w / 12);
      for (let i=0;i<n;i++){
        const x = hz.x + i*12;
        ctx.beginPath();
        ctx.moveTo(x, hz.y + hz.h);
        ctx.lineTo(x+6, hz.y);
        ctx.lineTo(x+12, hz.y + hz.h);
        ctx.stroke();
      }
    }

    // Goal
    ctx.fillStyle = "rgba(231,236,255,.85)";
    ctx.fillRect(goal.x+8, goal.y, 6, goal.h);
    ctx.fillStyle = "rgba(255,255,255,.9)";
    ctx.beginPath();
    ctx.moveTo(goal.x+14, goal.y+10);
    ctx.lineTo(goal.x+48, goal.y+22);
    ctx.lineTo(goal.x+14, goal.y+34);
    ctx.closePath();
    ctx.fill();
    ctx.font = "16px system-ui, Arial";
    ctx.fillText("üèÅ", goal.x+22, goal.y+70);

    // Hearts
    for (const h of hearts) {
      if (h.taken) continue;
      h.t += 0.06;
      const pulse = 1 + Math.sin(h.t) * 0.08;
      ctx.save();
      ctx.translate(h.x, h.y);
      ctx.scale(pulse, pulse);
      ctx.font = "26px system-ui, Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("‚ù§Ô∏è", 0, 0);
      ctx.restore();
    }

    // Player
    ctx.fillStyle = "rgba(231,236,255,.92)";
    ctx.fillRect(player.x, player.y, player.w, player.h);
    ctx.strokeStyle = "rgba(36,48,85,.9)";
    ctx.strokeRect(player.x, player.y, player.w, player.h);

    ctx.restore();
  }
</script>
</body>
</html>
